@model IEnumerable<ProyectoIntegradorS6G7.Models.Credito>

<div class="container-fluid py-4" style="background-color: #f4f7fe; min-height: 100vh;">

    <!-- Filtros y Búsqueda -->
    <form method="get" asp-action="Index">
        <div class="d-flex gap-3 mb-4 bg-white p-3 rounded-4 shadow-sm align-items-center">
            <div class="flex-grow-1 position-relative">
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                <input type="text" name="buscar" class="form-control border-0 bg-light ps-5 py-2 rounded-3"
                       placeholder="Buscar por RUC del cliente..." value="@ViewData["FiltroActual"]">
            </div>
            <div style="width: 200px;">
                <input type="date" name="fecha" class="form-control border-0 bg-light py-2 rounded-3">
            </div>
            <div style="width: 150px;">
                <select name="estado" class="form-select border-0 bg-light py-2 rounded-3">
                    <option value="">Todos los estados</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Vencido">Vencido</option>
                    <option value="Pagado">Pagado</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary px-3 py-2 rounded-3">
                <i class="bi bi-funnel me-1"></i> Filtrar
            </button>
            <button type="button" class="btn text-white px-4 py-2 rounded-3 fw-bold"
                    style="background-color: #5D5FEF;" data-bs-toggle="modal" data-bs-target="#modalRegistroPago">
                <i class="bi bi-cash-coin me-2"></i> REGISTRAR COBRO
            </button>
        </div>
    </form>

    <!-- Tarjetas de Resumen -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 p-4 text-center">
                <small class="text-muted text-uppercase">Total Obligaciones Activas</small>
                <h2 class="fw-bold text-primary mt-2">@Model.Count()</h2>
                <small class="text-muted">créditos pendientes de cobro</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 p-4 text-center">
                <small class="text-muted text-uppercase">Monto Total Pendiente</small>
                <h2 class="fw-bold text-danger mt-2">$@Model.Sum(c => c.montoTotal).ToString("N2")</h2>
                <small class="text-muted">saldo por cobrar</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 p-4 text-center">
                <small class="text-muted text-uppercase">Créditos en Riesgo</small>
                <h2 class="fw-bold text-warning mt-2">@Model.Count(c => c.nivelRiesgoIA == "ALTO")</h2>
                <small class="text-muted">nivel de riesgo alto</small>
            </div>
        </div>
    </div>

    <!-- Tabla de Cobranzas -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle">
                <thead class="text-muted small" style="background-color: #fafbfc;">
                    <tr>
                        <th class="ps-4 py-3">CÓDIGO</th>
                        <th>CLIENTE</th>
                        <th>MONTO PENDIENTE</th>
                        <th>CUOTAS RESTANTES</th>
                        <th>NIVEL RIESGO</th>
                        <th class="text-center">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="ps-4 fw-bold text-primary">#@item.idObligacion</td>
                            <td>
                                <div class="fw-bold text-dark">RUC: @item.rucCliente</div>
                                <div class="small text-muted">Registrado: @item.fechaRegistro.ToString("dd/MM/yyyy")</div>
                            </td>
                            <td class="fw-bold fs-5 text-danger">$@item.montoTotal.ToString("N2")</td>
                            <td>
                                <span class="badge bg-warning-subtle text-warning px-3 py-2">
                                    @item.cuotas cuotas
                                </span>
                            </td>
                            <td>
                                <span class="badge @(item.nivelRiesgoIA == "ALTO" ? "bg-danger" : "bg-success") px-3 py-2">
                                    @item.nivelRiesgoIA
                                </span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm text-white px-3 py-2 rounded-3 shadow-sm"
                                        style="background-color: #9A9CFF;"
                                        onclick="abrirModalPago('@item.idObligacion')">
                                    <i class="bi bi-cash-stack me-1"></i> Registrar Pago
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="card-footer bg-white border-0 d-flex justify-content-between align-items-center py-3">
            <span class="text-muted small">Mostrando 1-@Model.Count() de @Model.Count() obligaciones</span>
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item disabled"><a class="page-link border-0"><i class="bi bi-chevron-left"></i></a></li>
                    <li class="page-item active"><a class="page-link border-0" style="background-color: #9A9CFF;">1</a></li>
                    <li class="page-item"><a class="page-link border-0 text-muted">2</a></li>
                    <li class="page-item"><a class="page-link border-0 text-muted"><i class="bi bi-chevron-right"></i></a></li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- MODAL PARA REGISTRAR PAGO -->
<div class="modal fade" id="modalRegistroPago" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header bg-primary text-white rounded-top-4" style="background: linear-gradient(90deg, #1f2b6c, #4f6bed) !important;">
                <h5 class="modal-title fw-bold"><i class="bi bi-cash-coin me-2"></i>Registrar Pago de Cuota</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small text-muted fw-bold">ID Obligación</label>
                        <input type="text" id="inputIdObligacion" class="form-control border-0 bg-light rounded-3 py-2"
                               placeholder="FACT-XXXXX-2026">
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="buscarCredito()">
                            <i class="bi bi-search me-1"></i> Buscar
                        </button>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted fw-bold">Cliente</label>
                        <input type="text" id="displayCliente" class="form-control border-0 bg-light rounded-3 py-2" readonly>
                    </div>
                </div>

                <div id="detalleCuotas" style="display: none;" class="mt-4">
                    <hr>
                    <h6 class="fw-bold mb-3">Seleccionar Cuota a Pagar</h6>
                    <div id="listaCuotas" class="row g-2">
                        <!-- Cuotas se cargan dinámicamente -->
                    </div>

                    <div class="mt-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small text-muted fw-bold">Método de Pago</label>
                                <select id="inputMetodoPago" class="form-select border-0 bg-light rounded-3 py-2">
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Transferencia">Transferencia Bancaria</option>
                                    <option value="Tarjeta">Tarjeta de Crédito/Débito</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-muted fw-bold">Monto a Pagar</label>
                                <input type="number" id="inputMonto" class="form-control border-0 bg-light rounded-3 py-2" readonly>
                            </div>
                            <div class="col-12">
                                <label class="form-label small text-muted fw-bold">Observaciones</label>
                                <textarea id="inputObservaciones" class="form-control border-0 bg-light rounded-3" rows="2"
                                          placeholder="Comentarios adicionales..."></textarea>
                                <!-- Canvas para firma digital -->
                                <canvas id="canvasFirma" width="600" height="200"></canvas>
                                <button onclick="limpiarFirma()">Limpiar Firma</button>

                                <!-- Input para comprobante -->
                                <input type="file" id="inputComprobante" accept="image/*,.pdf">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-light rounded-3 px-4" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary rounded-3 px-4" onclick="confirmarPago()" style="background: linear-gradient(90deg, #1f2b6c, #4f6bed);">
                    <i class="bi bi-check-circle me-2"></i> Confirmar Pago
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .table thead th {
        border-bottom: none;
    }

    .table td {
        border-top: 1px solid #f1f1f1;
        padding: 1.2rem 0.75rem;
    }

    .page-link {
        border-radius: 8px !important;
        margin: 0 3px;
    }

    .cuota-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .cuota-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .cuota-card.selected {
            border: 2px solid #4F6BED !important;
            background-color: #EEF2FF;
        }

        .cuota-card.pagado {
            opacity: 0.5;
            cursor: not-allowed;
        }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let creditoSeleccionado = null;
        let cuotaSeleccionada = null;

        // Abrir modal desde tabla
        function abrirModalPago(idObligacion) {
            document.getElementById('inputIdObligacion').value = idObligacion;
            $('#modalRegistroPago').modal('show');
            buscarCredito();
        }

        // Buscar crédito y mostrar cuotas
        function buscarCredito() {
            const idObligacion = document.getElementById('inputIdObligacion').value;

            if (!idObligacion) {
                Swal.fire('Atención', 'Ingrese un ID de obligación', 'warning');
                return;
            }

            fetch(`/Cobranzas/ObtenerDetalleCuotas?idObligacion=${idObligacion}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        creditoSeleccionado = data.credito;
                        document.getElementById('displayCliente').value =
                            `${data.credito.razonSocial} (RUC: ${data.credito.rucCliente})`;

                        // Mostrar cuotas
                        const listaCuotas = document.getElementById('listaCuotas');
                        listaCuotas.innerHTML = '';

                        data.cuotas.forEach(cuota => {
                            const div = document.createElement('div');
                            div.className = 'col-md-3';
                            div.innerHTML = `
                                <div class="card cuota-card ${cuota.pagado ? 'pagado' : ''} border rounded-3 p-3 text-center"
                                     onclick="${!cuota.pagado ? `seleccionarCuota(${cuota.numero}, ${cuota.monto})` : ''}">
                                    <h6 class="fw-bold">Cuota ${cuota.numero}</h6>
                                    <p class="mb-0 small text-muted">$${cuota.monto.toFixed(2)}</p>
                                    <span class="badge ${cuota.pagado ? 'bg-success' : 'bg-warning'} mt-2">
                                        ${cuota.estado}
                                    </span>
                                </div>
                            `;
                            listaCuotas.appendChild(div);
                        });

                        document.getElementById('detalleCuotas').style.display = 'block';
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'No se pudo obtener la información', 'error');
                });
        }

        // Seleccionar cuota
        function seleccionarCuota(numero, monto) {
            // Limpiar selección anterior
            document.querySelectorAll('.cuota-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Marcar nueva selección
            event.currentTarget.classList.add('selected');
            cuotaSeleccionada = numero;
            document.getElementById('inputMonto').value = monto.toFixed(2);
        }


                const canvas = document.getElementById('canvasFirma');
        const ctx = canvas.getContext('2d');
        let dibujando = false;

        canvas.addEventListener('mousedown', (e) => {
            dibujando = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (dibujando) {
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', () => dibujando = false);

        // Touch para móviles
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            dibujando = true;
            ctx.beginPath();
            ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        });

        canvas.addEventListener('touchmove', (e) => {
            if (dibujando) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                ctx.stroke();
            }
        });

        function limpiarFirma() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
                function confirmarPago() {
            const formData = new FormData();
            formData.append('idObligacion', creditoSeleccionado.idObligacion);
            formData.append('numeroCuota', cuotaSeleccionada);
            formData.append('monto', document.getElementById('inputMonto').value);
            formData.append('metodoPago', document.getElementById('inputMetodoPago').value);

            // Comprobante
            const comprobante = document.getElementById('inputComprobante').files[0];
            if (comprobante) {
                formData.append('comprobante', comprobante);
            }

            // Firma en base64
            formData.append('firmaBase64', canvas.toDataURL());

            fetch('/Cobranzas/RegistrarPago', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', data.message, 'success');
                }
            });
        }

        // Confirmar pago
        function confirmarPago() {
            if (!creditoSeleccionado || !cuotaSeleccionada) {
                Swal.fire('Atención', 'Debe seleccionar una cuota para pagar', 'warning');
                return;
            }

            const datos = {
                idObligacion: creditoSeleccionado.idObligacion,
                numeroCuota: cuotaSeleccionada,
                monto: parseFloat(document.getElementById('inputMonto').value),
                metodoPago: document.getElementById('inputMetodoPago').value,
                observaciones: document.getElementById('inputObservaciones').value
            };

            fetch('/Cobranzas/RegistrarPago', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(datos)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: '¡Pago Registrado!',
                        html: `
                            <p>${data.message}</p>
                            <p class="fw-bold">Recibo: ${data.recibo}</p>
                            ${data.creditoCompleto ? '<p class="text-success">✓ Crédito totalmente pagado</p>' : ''}
                        `,
                        icon: 'success',
                        confirmButtonColor: '#1F2B6C'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo registrar el pago', 'error');
            });
        }
    </script>
}